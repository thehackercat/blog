<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>è®°ä¸€æ¬¡ k8s apiserver watch hang é—®é¢˜æ’æŸ¥ - LexusLee&#39;s blog</title><meta name="Description" content="LexusLee personal blog, recording things you people wouldn&#39;t believe. Like attack ships on fire off the shoulder of Orion, c-beams glitter in the dark near the Tannhauser Gate."><meta property="og:title" content="è®°ä¸€æ¬¡ k8s apiserver watch hang é—®é¢˜æ’æŸ¥" />
<meta property="og:description" content="Lexus Lee è®°ä¸€æ¬¡ k8s apiserver watch hang é—®é¢˜æ’æŸ¥ é—®é¢˜èƒŒæ™¯ æ³¨ğŸ“¢: æœ¬æ–‡ä¸­æ¶‰åŠ apiserver åœ°å€å’Œ ingressgateway åœ°å€, ä¸ºè„±æ•å¤„ç†, å°†ä¼šåšé©¬èµ›å…‹å¤„ç†ï¼ï¼ï¼
ä¼ ç»Ÿçš„ kubernetes apiserver è¯·æ±‚è®¿é—®é“¾è·¯ä¸ºå®¢æˆ·ç«¯ç›´è¿ apiserverï¼Œä¸ºäº†åš apiserver é«˜å¯ç”¨ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šç»™ apiserver å‰ç«¯å†å¥—ä¸€å±‚4å±‚æˆ–7å±‚ä»£ç†åšå¤šä¸ª apiserver å®ä¾‹çš„è´Ÿè½½å‡è¡¡ã€‚
åœ¨æˆ‘ä»¬çš„åœºæ™¯ä¸‹ï¼Œä½¿ç”¨äº† istio çš„ ingressgateway ä½œä¸º client -&gt; apiserver è¿™æ¡é“¾è·¯ä¸­çš„7å±‚ä»£ç†ã€‚é“¾è·¯å˜æˆäº† client -&gt; ingressgateway -&gt; apiserver ï¼Œgateway æš´éœ² 80 ç«¯å£ä¾›å®¢æˆ·ç«¯è®¿é—®, åŒæ—¶é€šè¿‡ istio virtualService &#43; destinationRule è§„åˆ™é…ç½® gateway èƒ½é€šè¿‡åŸŸåè®¿é—®åˆ° apiserver 6443 ç«¯å£ï¼Œä»è€Œå®ç°æµé‡è·¯ç”±ã€‚
å…·ä½“é“¾è·¯å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œ
åœ¨è¿™æ ·çš„é“¾è·¯ä¸‹ï¼Œæˆ‘ä»¬é‡åˆ°äº†å¦‚ä¸‹é—®é¢˜ï¼Œ
åœ¨ k8s apiserver 1.18 ç‰ˆæœ¬çš„é›†ç¾¤åœ¨æ»šåŠ¨é‡å¯è¿‡å‡ºç°éƒ¨åˆ†ç»„ä»¶æ— æ³• watch åˆ°äº‹ä»¶çš„æƒ…å†µï¼Œå®¢æˆ·ç«¯ watch è¯·æ±‚å¶å‘ 503ã€‚éœ€è¦é‡å¯ç»„ä»¶ï¼Œé‡å»º watch è¿æ¥æ‰èƒ½æ¢å¤ã€‚" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://example.com/k8s-api-watch-hang-dignosis/" /><meta property="og:image" content="https://example.com/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-02-13T21:55:54+08:00" />
<meta property="article:modified_time" content="2022-02-13T21:55:54+08:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://example.com/logo.png"/>

<meta name="twitter:title" content="è®°ä¸€æ¬¡ k8s apiserver watch hang é—®é¢˜æ’æŸ¥"/>
<meta name="twitter:description" content="Lexus Lee è®°ä¸€æ¬¡ k8s apiserver watch hang é—®é¢˜æ’æŸ¥ é—®é¢˜èƒŒæ™¯ æ³¨ğŸ“¢: æœ¬æ–‡ä¸­æ¶‰åŠ apiserver åœ°å€å’Œ ingressgateway åœ°å€, ä¸ºè„±æ•å¤„ç†, å°†ä¼šåšé©¬èµ›å…‹å¤„ç†ï¼ï¼ï¼
ä¼ ç»Ÿçš„ kubernetes apiserver è¯·æ±‚è®¿é—®é“¾è·¯ä¸ºå®¢æˆ·ç«¯ç›´è¿ apiserverï¼Œä¸ºäº†åš apiserver é«˜å¯ç”¨ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šç»™ apiserver å‰ç«¯å†å¥—ä¸€å±‚4å±‚æˆ–7å±‚ä»£ç†åšå¤šä¸ª apiserver å®ä¾‹çš„è´Ÿè½½å‡è¡¡ã€‚
åœ¨æˆ‘ä»¬çš„åœºæ™¯ä¸‹ï¼Œä½¿ç”¨äº† istio çš„ ingressgateway ä½œä¸º client -&gt; apiserver è¿™æ¡é“¾è·¯ä¸­çš„7å±‚ä»£ç†ã€‚é“¾è·¯å˜æˆäº† client -&gt; ingressgateway -&gt; apiserver ï¼Œgateway æš´éœ² 80 ç«¯å£ä¾›å®¢æˆ·ç«¯è®¿é—®, åŒæ—¶é€šè¿‡ istio virtualService &#43; destinationRule è§„åˆ™é…ç½® gateway èƒ½é€šè¿‡åŸŸåè®¿é—®åˆ° apiserver 6443 ç«¯å£ï¼Œä»è€Œå®ç°æµé‡è·¯ç”±ã€‚
å…·ä½“é“¾è·¯å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œ
åœ¨è¿™æ ·çš„é“¾è·¯ä¸‹ï¼Œæˆ‘ä»¬é‡åˆ°äº†å¦‚ä¸‹é—®é¢˜ï¼Œ
åœ¨ k8s apiserver 1.18 ç‰ˆæœ¬çš„é›†ç¾¤åœ¨æ»šåŠ¨é‡å¯è¿‡å‡ºç°éƒ¨åˆ†ç»„ä»¶æ— æ³• watch åˆ°äº‹ä»¶çš„æƒ…å†µï¼Œå®¢æˆ·ç«¯ watch è¯·æ±‚å¶å‘ 503ã€‚éœ€è¦é‡å¯ç»„ä»¶ï¼Œé‡å»º watch è¿æ¥æ‰èƒ½æ¢å¤ã€‚"/>
<meta name="application-name" content="Nice to meet you">
<meta name="apple-mobile-web-app-title" content="Nice to meet you"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="icon" href="/images/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://example.com/k8s-api-watch-hang-dignosis/" /><link rel="prev" href="https://example.com/its-ok-douban/" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "è®°ä¸€æ¬¡ k8s apiserver watch hang é—®é¢˜æ’æŸ¥",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/example.com\/k8s-api-watch-hang-dignosis\/"
        },"image": ["https:\/\/example.com\/images\/Apple-Devices-Preview.png"],"genre": "posts","keywords": "Kubernetes, Linux","wordcount":  849 ,
        "url": "https:\/\/example.com\/k8s-api-watch-hang-dignosis\/","datePublished": "2022-02-13T21:55:54+08:00","dateModified": "2022-02-13T21:55:54+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "LexusLee","logo": {
                    "@type": "ImageObject",
                    "url": "https:\/\/example.com\/images\/avatar.png",
                    "width":  552 ,
                    "height":  608 
                }},"author": {
                "@type": "Person",
                "name": "LexusLee"
            },"description": ""
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="LexusLee&#39;s blog"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span>Nice to meet you</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/categories/"> Categories </a><a class="menu-item" href="/photo/"> Photo </a><a class="menu-item" href="/about/"> About </a><a class="menu-item" href="https://github.com/thehackercat" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item language" title="Select Language">English<i class="fas fa-chevron-right fa-fw"></i>
                        <select class="language-select" id="language-select-desktop" onchange="location = this.value;"><option value="/k8s-api-watch-hang-dignosis/" selected>English</option><option value="/zh-cn/k8s-api-watch-hang-dignosis/">ç®€ä½“ä¸­æ–‡</option></select>
                    </a><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="LexusLee&#39;s blog"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span>Nice to meet you</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/categories/" title="">Categories</a><a class="menu-item" href="/photo/" title="">Photo</a><a class="menu-item" href="/about/" title="">About</a><a class="menu-item" href="https://github.com/thehackercat" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
            </a><a href="javascript:void(0);" class="menu-item" title="Select Language">English<i class="fas fa-chevron-right fa-fw"></i>
                    <select class="language-select" onchange="location = this.value;"><option value="/k8s-api-watch-hang-dignosis/" selected>English</option><option value="/zh-cn/k8s-api-watch-hang-dignosis/">ç®€ä½“ä¸­æ–‡</option></select>
                </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">è®°ä¸€æ¬¡ k8s apiserver watch hang é—®é¢˜æ’æŸ¥</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>LexusLee</a></span>&nbsp;<span class="post-category">included in <a href="/categories/coding/"><i class="far fa-folder fa-fw"></i>Coding</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2022-02-13">2022-02-13</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;849 words&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;4 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#é—®é¢˜èƒŒæ™¯">é—®é¢˜èƒŒæ™¯</a></li>
    <li><a href="#é—®é¢˜ç°è±¡">é—®é¢˜ç°è±¡</a></li>
    <li><a href="#æ’æŸ¥è¿‡ç¨‹">æ’æŸ¥è¿‡ç¨‹</a>
      <ul>
        <li><a href="#ç¯å¢ƒ">ç¯å¢ƒ</a></li>
        <li><a href="#å¤ç°">å¤ç°</a>
          <ul>
            <li><a href="#1-æ–°å»ºè°ƒè¯•ç½‘å…³-éš”ç¦»çº¿ä¸Šæµé‡">1. æ–°å»ºè°ƒè¯•ç½‘å…³, éš”ç¦»çº¿ä¸Šæµé‡</a></li>
            <li><a href="#2-ä¿®æ”¹æœ¬åœ°-dns-å°†æµé‡æ‰“å‘ç½‘å…³">2. ä¿®æ”¹æœ¬åœ° dns, å°†æµé‡æ‰“å‘ç½‘å…³</a></li>
            <li><a href="#3-æœ¬åœ°å¯åŠ¨è„šæœ¬æ¨¡æ‹Ÿ-watch-è¯·æ±‚">3. æœ¬åœ°å¯åŠ¨è„šæœ¬æ¨¡æ‹Ÿ watch è¯·æ±‚</a></li>
          </ul>
        </li>
        <li><a href="#æ’æŸ¥">æ’æŸ¥</a></li>
        <li><a href="#æ‰¾è§£å†³æ–¹æ¡ˆ">æ‰¾è§£å†³æ–¹æ¡ˆ</a></li>
        <li><a href="#éªŒè¯">éªŒè¯</a></li>
        <li><a href="#æ ¹æ®-pprof-è¿›è¡Œç»“è®ºçš„äºŒæ¬¡éªŒè¯">æ ¹æ® pprof è¿›è¡Œç»“è®ºçš„äºŒæ¬¡éªŒè¯</a></li>
      </ul>
    </li>
    <li><a href="#é—®é¢˜æ ¹å› ">é—®é¢˜æ ¹å› </a></li>
    <li><a href="#æ€è€ƒ">æ€è€ƒ</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><div style="text-align: right;">Lexus Lee</div>
<h1 id="è®°ä¸€æ¬¡-k8s-apiserver-watch-hang-é—®é¢˜æ’æŸ¥">è®°ä¸€æ¬¡ k8s apiserver watch hang é—®é¢˜æ’æŸ¥</h1>
<h2 id="é—®é¢˜èƒŒæ™¯">é—®é¢˜èƒŒæ™¯</h2>
<p><em>æ³¨ğŸ“¢: æœ¬æ–‡ä¸­æ¶‰åŠ apiserver åœ°å€å’Œ ingressgateway åœ°å€, ä¸ºè„±æ•å¤„ç†, å°†ä¼šåšé©¬èµ›å…‹å¤„ç†ï¼ï¼ï¼</em></p>
<p>ä¼ ç»Ÿçš„ kubernetes apiserver è¯·æ±‚è®¿é—®é“¾è·¯ä¸ºå®¢æˆ·ç«¯ç›´è¿ apiserverï¼Œä¸ºäº†åš apiserver é«˜å¯ç”¨ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šç»™ apiserver å‰ç«¯å†å¥—ä¸€å±‚4å±‚æˆ–7å±‚ä»£ç†åšå¤šä¸ª apiserver å®ä¾‹çš„è´Ÿè½½å‡è¡¡ã€‚</p>
<p>åœ¨æˆ‘ä»¬çš„åœºæ™¯ä¸‹ï¼Œä½¿ç”¨äº† istio çš„ ingressgateway ä½œä¸º <code>client -&gt; apiserver</code> è¿™æ¡é“¾è·¯ä¸­çš„7å±‚ä»£ç†ã€‚é“¾è·¯å˜æˆäº† <code>client -&gt; ingressgateway -&gt; apiserver</code> ï¼Œgateway æš´éœ² 80 ç«¯å£ä¾›å®¢æˆ·ç«¯è®¿é—®, åŒæ—¶é€šè¿‡ istio virtualService + destinationRule è§„åˆ™é…ç½® gateway èƒ½é€šè¿‡åŸŸåè®¿é—®åˆ° apiserver 6443 ç«¯å£ï¼Œä»è€Œå®ç°æµé‡è·¯ç”±ã€‚</p>
<p>å…·ä½“é“¾è·¯å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œ</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://tva1.sinaimg.cn/large/008i3skNgy1gzbztm2qpgj31320em40j.jpg"
        data-srcset="https://tva1.sinaimg.cn/large/008i3skNgy1gzbztm2qpgj31320em40j.jpg, https://tva1.sinaimg.cn/large/008i3skNgy1gzbztm2qpgj31320em40j.jpg 1.5x, https://tva1.sinaimg.cn/large/008i3skNgy1gzbztm2qpgj31320em40j.jpg 2x"
        data-sizes="auto"
        alt="https://tva1.sinaimg.cn/large/008i3skNgy1gzbztm2qpgj31320em40j.jpg"
        title="ç°åœ¨ apiserver è®¿é—®é“¾è·¯" /></p>
<p>åœ¨è¿™æ ·çš„é“¾è·¯ä¸‹ï¼Œæˆ‘ä»¬é‡åˆ°äº†å¦‚ä¸‹é—®é¢˜ï¼Œ</p>
<p>åœ¨ k8s apiserver 1.18 ç‰ˆæœ¬çš„é›†ç¾¤åœ¨æ»šåŠ¨é‡å¯è¿‡å‡ºç°éƒ¨åˆ†ç»„ä»¶æ— æ³• watch åˆ°äº‹ä»¶çš„æƒ…å†µï¼Œå®¢æˆ·ç«¯ watch è¯·æ±‚å¶å‘ 503ã€‚éœ€è¦é‡å¯ç»„ä»¶ï¼Œé‡å»º watch è¿æ¥æ‰èƒ½æ¢å¤ã€‚</p>
<h2 id="é—®é¢˜ç°è±¡">é—®é¢˜ç°è±¡</h2>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://tva1.sinaimg.cn/large/008i3skNgy1gzbzsiptdej319q0iujvi.jpg"
        data-srcset="https://tva1.sinaimg.cn/large/008i3skNgy1gzbzsiptdej319q0iujvi.jpg, https://tva1.sinaimg.cn/large/008i3skNgy1gzbzsiptdej319q0iujvi.jpg 1.5x, https://tva1.sinaimg.cn/large/008i3skNgy1gzbzsiptdej319q0iujvi.jpg 2x"
        data-sizes="auto"
        alt="https://tva1.sinaimg.cn/large/008i3skNgy1gzbzsiptdej319q0iujvi.jpg"
        title="æœ¬æ¬¡æ•…éšœä¸­ apiserver è®¿é—®é“¾è·¯" /></p>
<p>ç”±äº k8s watch è¯·æ±‚æ˜¯ http2 åè®®, æ•… client ä¸ gateway ä¹‹é—´ä¿æŒäº†é•¿è¿æ¥ï¼ŒåŒæ—¶ gateway ä¸åç«¯ä¹Ÿä¿æŒé•¿è¿æ¥ã€‚</p>
<p>å½“ apiserver å‘ç”Ÿæ»šåŠ¨é‡å»ºåï¼Œgateway ä¸æ—§ apiserver è¿æ¥æ–­å¼€ï¼ŒåŒæ—¶ä¸æ–° apiserver å»ºè¿ã€‚æ­¤æ—¶ client ä¸ gateway ä»ç„¶ä¿æŒç€åŸæ¥é‚£æ ¹è¿æ¥ï¼Œæ•…åœ¨ä¸é‡å»º 7 å±‚ http2 è¿æ¥çš„æƒ…å†µä¸‹ï¼Œè¯·æ±‚æ²¡æ³•æ‰“åˆ° new apiserverã€‚</p>
<p>æ•…å®¢æˆ·ç«¯è™½ç„¶ä¸ Upstream ç½‘å…³è¿æ¥æ­£å¸¸ï¼Œä½†ç½‘å…³ä¸ apiserver ä¾§å¯èƒ½ä»ä½¿ç”¨åˆ°æ—§ apiserver çš„è¿æ¥å¯¹ï¼Œå¯¼è‡´æ— æ³• watch åˆ°äº‹ä»¶ã€‚</p>
<p>å…·ä½“ç°è±¡ä¸º</p>
<ol>
<li>å®¢æˆ·ç«¯å‡ºç° watch è¯·æ±‚ hang ä½, å¶å‘å‡ºç° watch è¯·æ±‚ 503, æŠ¥é”™ä¸º: <code>server is currently unable to handler the requests</code> <img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://tva1.sinaimg.cn/large/008i3skNgy1gzbztytugsj325g09gn1l.jpg"
        data-srcset="https://tva1.sinaimg.cn/large/008i3skNgy1gzbztytugsj325g09gn1l.jpg, https://tva1.sinaimg.cn/large/008i3skNgy1gzbztytugsj325g09gn1l.jpg 1.5x, https://tva1.sinaimg.cn/large/008i3skNgy1gzbztytugsj325g09gn1l.jpg 2x"
        data-sizes="auto"
        alt="https://tva1.sinaimg.cn/large/008i3skNgy1gzbztytugsj325g09gn1l.jpg"
        title="503å®¢æˆ·ç«¯æˆªå›¾" /></li>
<li>é€šè¿‡ pprof æŸ¥çœ‹åˆ° client-go ListAndWatch å‡½æ•°ä¸­çš„ <code>watchHandler</code> æ‰§è¡Œäº† 6000+ åˆ†é’Ÿ, å®é™…åº”è¯¥åœ¨ 5-10 åˆ†é’Ÿåå°±é€€å‡ºé‡è¿ã€‚</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://tva1.sinaimg.cn/large/008i3skNgy1gzc6lt71lyj32460hadpv.jpg"
        data-srcset="https://tva1.sinaimg.cn/large/008i3skNgy1gzc6lt71lyj32460hadpv.jpg, https://tva1.sinaimg.cn/large/008i3skNgy1gzc6lt71lyj32460hadpv.jpg 1.5x, https://tva1.sinaimg.cn/large/008i3skNgy1gzc6lt71lyj32460hadpv.jpg 2x"
        data-sizes="auto"
        alt="https://tva1.sinaimg.cn/large/008i3skNgy1gzc6lt71lyj32460hadpv.jpg"
        title="503pprofæˆªå›¾" /></p>
<h2 id="æ’æŸ¥è¿‡ç¨‹">æ’æŸ¥è¿‡ç¨‹</h2>
<p>é¦–å…ˆæˆ‘çš„ç–‘ç‚¹æ˜¯ç½‘å…³ä¾§(ingressgateway)é…ç½®ä¸æ­£ç¡®å¯¼è‡´äº†ç½‘å…³å’Œæ—§ apiserver è¿æ¥ä»ä¿æŒï¼Œä»è€Œå¯¼è‡´äº†å®¢æˆ·ç«¯(client) watch è¯·æ±‚æ²¡æœ‰æ‰“åˆ°æ–° apiserver ä¸Šï¼Œä½†ç½‘å…³ä¾§æ²¡æœ‰äº†ç°åœºæ›´å¤šä¿¡æ¯ï¼Œä¸”çº¿ä¸Š apiserver é›†ç¾¤ä¸èƒ½é¢‘ç¹é‡å¯ï¼Œæ•…å°è¯•ç”¨é£é™©è¾ƒä½çš„åœºæ™¯<strong>å¤ç°é—®é¢˜</strong>ã€‚</p>
<h3 id="ç¯å¢ƒ">ç¯å¢ƒ</h3>
<ul>
<li>ä¸¤å° apiserver å®ä¾‹(apiserver1ã€apiserver2)</li>
<li>ä¸€å°ç½‘å…³å®ä¾‹ (ingressgateway1)</li>
<li>ä¸ªäººPCå¯åŠ¨ k8s client</li>
</ul>
<h3 id="å¤ç°">å¤ç°</h3>
<p>çº¿ä¸‹è°ƒè¯•é›†ç¾¤ apiserver (ä¹‹åç®€ç§°è¯¥é›†ç¾¤ä¸º staging é›†ç¾¤)è¯·æ±‚ä¸€å…±æœ‰2å®ä¾‹, è„±æ•è€ƒè™‘ï¼Œæˆ‘ä»¬ç®€å†™å…¶ ip ä¸º apiserverIp1ã€apiserverIp2</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://tva1.sinaimg.cn/large/008i3skNgy1gzbzywk9dgj324q0aywgy.jpg"
        data-srcset="https://tva1.sinaimg.cn/large/008i3skNgy1gzbzywk9dgj324q0aywgy.jpg, https://tva1.sinaimg.cn/large/008i3skNgy1gzbzywk9dgj324q0aywgy.jpg 1.5x, https://tva1.sinaimg.cn/large/008i3skNgy1gzbzywk9dgj324q0aywgy.jpg 2x"
        data-sizes="auto"
        alt="https://tva1.sinaimg.cn/large/008i3skNgy1gzbzywk9dgj324q0aywgy.jpg"
        title="æœ¬åœ°netstatæˆªå›¾" /></p>
<h4 id="1-æ–°å»ºè°ƒè¯•ç½‘å…³-éš”ç¦»çº¿ä¸Šæµé‡">1. æ–°å»ºè°ƒè¯•ç½‘å…³, éš”ç¦»çº¿ä¸Šæµé‡</h4>
<p>å…ˆåœ¨ç”Ÿäº§ç¯å¢ƒå•ç‹¬èµ·äº†ä¸€ä¸ª ingressgateway ç½‘å…³å®ä¾‹ï¼Œç”¨äºéš”ç¦»çº¿ä¸Šæµé‡ï¼Œä»…æ¥æ”¶æˆ‘çš„æœ¬åœ°è°ƒè¯•æµé‡</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://tva1.sinaimg.cn/large/008i3skNly1gzc6pins06j324i03iwfd.jpg"
        data-srcset="https://tva1.sinaimg.cn/large/008i3skNly1gzc6pins06j324i03iwfd.jpg, https://tva1.sinaimg.cn/large/008i3skNly1gzc6pins06j324i03iwfd.jpg 1.5x, https://tva1.sinaimg.cn/large/008i3skNly1gzc6pins06j324i03iwfd.jpg 2x"
        data-sizes="auto"
        alt="https://tva1.sinaimg.cn/large/008i3skNly1gzc6pins06j324i03iwfd.jpg"
        title="å•å°è°ƒè¯•ç½‘å…³å®ä¾‹" /></p>
<h4 id="2-ä¿®æ”¹æœ¬åœ°-dns-å°†æµé‡æ‰“å‘ç½‘å…³">2. ä¿®æ”¹æœ¬åœ° dns, å°†æµé‡æ‰“å‘ç½‘å…³</h4>
<p>æ­¤æ—¶åœ¨ <code>/etc/hosts</code> ä¸­å°† staging é›†ç¾¤ apiserver è¯·æ±‚å®šå‘æŒ‡å‘è¯¥ ingressgateway å®ä¾‹</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5ptnwg5j31fq0gwq6d.jpg"
        data-srcset="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5ptnwg5j31fq0gwq6d.jpg, https://tva1.sinaimg.cn/large/008i3skNgy1gzc5ptnwg5j31fq0gwq6d.jpg 1.5x, https://tva1.sinaimg.cn/large/008i3skNgy1gzc5ptnwg5j31fq0gwq6d.jpg 2x"
        data-sizes="auto"
        alt="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5ptnwg5j31fq0gwq6d.jpg"
        title="hostsæ³¨å…¥å†…å®¹" /></p>
<h4 id="3-æœ¬åœ°å¯åŠ¨è„šæœ¬æ¨¡æ‹Ÿ-watch-è¯·æ±‚">3. æœ¬åœ°å¯åŠ¨è„šæœ¬æ¨¡æ‹Ÿ watch è¯·æ±‚</h4>
<p>åœ¨æœ¬åœ°å¯åŠ¨ä»¥ä¸‹è„šæœ¬ watch staging pod äº‹ä»¶</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-GO" data-lang="GO"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;flag&#34;</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="s">&#34;net/http&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;net/http/pprof&#34;</span>
	<span class="s">&#34;time&#34;</span>

	<span class="nx">v1</span> <span class="s">&#34;k8s.io/api/core/v1&#34;</span>
	<span class="s">&#34;k8s.io/apimachinery/pkg/fields&#34;</span>
	<span class="s">&#34;k8s.io/client-go/kubernetes&#34;</span>
	<span class="s">&#34;k8s.io/client-go/tools/cache&#34;</span>
	<span class="s">&#34;k8s.io/client-go/tools/clientcmd&#34;</span>
	<span class="s">&#34;k8s.io/klog/v2&#34;</span>
<span class="p">)</span>

<span class="kd">var</span> <span class="p">(</span>
	<span class="nx">kubeconfig</span>  <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;kubeconfig&#34;</span><span class="p">,</span> <span class="s">&#34;./config&#34;</span><span class="p">,</span> <span class="s">&#34;absolute path to the kubeconfig file&#34;</span><span class="p">)</span>
	<span class="nx">enableProxy</span> <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">Bool</span><span class="p">(</span><span class="s">&#34;enableProxy&#34;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="s">&#34;if true, enable http proxy&#34;</span><span class="p">)</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">klog</span><span class="p">.</span><span class="nf">InitFlags</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span>
	<span class="k">defer</span> <span class="nx">klog</span><span class="p">.</span><span class="nf">Flush</span><span class="p">()</span>
	<span class="nx">flag</span><span class="p">.</span><span class="nf">Parse</span><span class="p">()</span>
	<span class="nx">klog</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Starting test-watch-conn&#34;</span><span class="p">)</span>
	<span class="nx">config</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">clientcmd</span><span class="p">.</span><span class="nf">BuildConfigFromFlags</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">,</span> <span class="o">*</span><span class="nx">kubeconfig</span><span class="p">)</span>
	<span class="nx">config</span><span class="p">.</span><span class="nx">UserAgent</span> <span class="p">=</span> <span class="s">&#34;test-from-xiaoxu&#34;</span>
	<span class="k">if</span> <span class="o">*</span><span class="nx">enableProxy</span> <span class="p">{</span>
		<span class="nx">klog</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Enable proxy, disabling tls cert verification&#34;</span><span class="p">)</span>
		<span class="nx">config</span><span class="p">.</span><span class="nx">TLSClientConfig</span><span class="p">.</span><span class="nx">CAData</span> <span class="p">=</span> <span class="kc">nil</span>
		<span class="nx">config</span><span class="p">.</span><span class="nx">TLSClientConfig</span><span class="p">.</span><span class="nx">Insecure</span> <span class="p">=</span> <span class="kc">true</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
	<span class="p">}</span>
	<span class="nx">clientset</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">kubernetes</span><span class="p">.</span><span class="nf">NewForConfig</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
	<span class="p">}</span>
	<span class="c1">// Set hangFlag to test health of watching connection
</span><span class="c1"></span>	<span class="nx">hangFlag</span> <span class="o">:=</span> <span class="mi">1</span>

	<span class="nx">watchlist</span> <span class="o">:=</span> <span class="nx">cache</span><span class="p">.</span><span class="nf">NewListWatchFromClient</span><span class="p">(</span><span class="nx">clientset</span><span class="p">.</span><span class="nf">CoreV1</span><span class="p">().</span><span class="nf">RESTClient</span><span class="p">(),</span> <span class="s">&#34;pods&#34;</span><span class="p">,</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">NamespaceAll</span><span class="p">,</span>
		<span class="nx">fields</span><span class="p">.</span><span class="nf">Everything</span><span class="p">())</span>
	<span class="nx">_</span><span class="p">,</span> <span class="nx">controller</span> <span class="o">:=</span> <span class="nx">cache</span><span class="p">.</span><span class="nf">NewInformer</span><span class="p">(</span>
		<span class="nx">watchlist</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">{},</span>
		<span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="o">*</span><span class="mi">0</span><span class="p">,</span>
		<span class="nx">cache</span><span class="p">.</span><span class="nx">ResourceEventHandlerFuncs</span><span class="p">{</span>
			<span class="nx">AddFunc</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
				<span class="c1">// fmt.Printf(&#34;pods added...\n&#34;)
</span><span class="c1"></span>			<span class="p">},</span>
			<span class="nx">DeleteFunc</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
				<span class="c1">// fmt.Printf(&#34;pods deleted...\n&#34;)
</span><span class="c1"></span>			<span class="p">},</span>
			<span class="nx">UpdateFunc</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">oldObj</span><span class="p">,</span> <span class="nx">newObj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
				<span class="nx">currentTime</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
				<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;[%s] pods(%s) changed...\n&#34;</span><span class="p">,</span> <span class="nx">currentTime</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">&#34;2006-01-02 15:04:05&#34;</span><span class="p">),</span> <span class="nx">newObj</span><span class="p">.(</span><span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Pod</span><span class="p">).</span><span class="nx">Name</span><span class="p">)</span>
				<span class="k">if</span> <span class="nx">hangFlag</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">{</span>
					<span class="c1">// Reset hangFlag
</span><span class="c1"></span>					<span class="nx">hangFlag</span> <span class="p">=</span> <span class="mi">0</span>
				<span class="p">}</span>
			<span class="p">},</span>
		<span class="p">},</span>
	<span class="p">)</span>
	<span class="nx">stop</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span>
	<span class="k">go</span> <span class="nx">controller</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="nx">stop</span><span class="p">)</span>

	<span class="c1">// periodically check the connection
</span><span class="c1"></span>	<span class="nx">timer</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">NewTimer</span><span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">{</span>
			<span class="nx">timer</span><span class="p">.</span><span class="nf">Reset</span><span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
			<span class="k">select</span> <span class="p">{</span>
			<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">timer</span><span class="p">.</span><span class="nx">C</span><span class="p">:</span>
				<span class="k">if</span> <span class="nx">hangFlag</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">{</span>
					<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;[%s]!!!Watch connection hang\n&#34;</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">Format</span><span class="p">(</span><span class="s">&#34;2006-01-02 15:04:05&#34;</span><span class="p">))</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}()</span>
	<span class="c1">// start http server
</span><span class="c1"></span>	<span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="s">&#34;0.0.0.0:6061&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
	<span class="nx">klog</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Http server start, listening on 0.0.0.0:6061 : )&#34;</span><span class="p">)</span>
	<span class="k">for</span> <span class="p">{</span>
		<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>å¯åŠ¨è„šæœ¬å¼€å§‹ watch pod, è§‚å¯Ÿåˆ°æ­¤æ—¶ watch pod æ­£å¸¸.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5pzxaxaj31gi09sn1l.jpg"
        data-srcset="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5pzxaxaj31gi09sn1l.jpg, https://tva1.sinaimg.cn/large/008i3skNgy1gzc5pzxaxaj31gi09sn1l.jpg 1.5x, https://tva1.sinaimg.cn/large/008i3skNgy1gzc5pzxaxaj31gi09sn1l.jpg 2x"
        data-sizes="auto"
        alt="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5pzxaxaj31gi09sn1l.jpg"
        title="å®¢æˆ·ç«¯client-goæ—¥å¿—" /></p>
<p>æ­¤æ—¶ç™»å½• ingressgateway å®¹å™¨è§‚å¯Ÿåˆ°ç½‘å…³ä¸€å…±æœ‰2ä¸ªä¸ apiserver çš„è¿æ¥(è¿™å„¿çœ‹åˆ°çš„ 8080 ç«¯å£æ˜¯å› ä¸ºå¼€äº† istio sidecar)</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5q6w7q0j312o0a8wg5.jpg"
        data-srcset="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5q6w7q0j312o0a8wg5.jpg, https://tva1.sinaimg.cn/large/008i3skNgy1gzc5q6w7q0j312o0a8wg5.jpg 1.5x, https://tva1.sinaimg.cn/large/008i3skNgy1gzc5q6w7q0j312o0a8wg5.jpg 2x"
        data-sizes="auto"
        alt="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5q6w7q0j312o0a8wg5.jpg"
        title="istio-apiserverè®¿é—®é“¾è·¯" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5qd2fcfj324y07ijtu.jpg"
        data-srcset="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5qd2fcfj324y07ijtu.jpg, https://tva1.sinaimg.cn/large/008i3skNgy1gzc5qd2fcfj324y07ijtu.jpg 1.5x, https://tva1.sinaimg.cn/large/008i3skNgy1gzc5qd2fcfj324y07ijtu.jpg 2x"
        data-sizes="auto"
        alt="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5qd2fcfj324y07ijtu.jpg"
        title="åœ¨istio-apiserveré“¾è·¯ä¸‹netstatä¿¡æ¯" /></p>
<p>æ­¤æ—¶å¯¹<strong>å…¶ä¸­ä¸€ä¸ª apiserver å®ä¾‹</strong>æ³¨å…¥ä¸¢åŒ…è§„åˆ™ï¼Œæ¨¡æ‹Ÿ ingress -&gt; apiserver è¯·æ±‚å¤±è´¥ã€‚(<em>å¦ä¸€å° apiserver æ­£å¸¸</em>)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">iptables -A OUTPUT -p tcp --dst apiserver_ip_1 --dport <span class="m">8080</span> -j DROP
</code></pre></td></tr></table>
</div>
</div><p>å¹¶ä¸”åœ¨ç½‘å…³ä¾§åŒæ—¶å¯¹æ‰€æœ‰ apiserver å®ä¾‹ 8080 ç«¯å£è¿›è¡Œ tcpdump æŠ“åŒ…ï¼Œé¢„æœŸæƒ…å†µä¸‹ï¼Œapisever1 å°†ä¸å†å‡ºç°æ–°è¯·æ±‚ï¼ŒåŒæ—¶å¦ä¸€ä¸ªå¯ç”¨çš„  apiserver2 åº”è¯¥æ”¶åˆ°è¯·æ±‚ã€‚</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5rq23blj31kl0u0wpe.jpg"
        data-srcset="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5rq23blj31kl0u0wpe.jpg, https://tva1.sinaimg.cn/large/008i3skNgy1gzc5rq23blj31kl0u0wpe.jpg 1.5x, https://tva1.sinaimg.cn/large/008i3skNgy1gzc5rq23blj31kl0u0wpe.jpg 2x"
        data-sizes="auto"
        alt="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5rq23blj31kl0u0wpe.jpg"
        title="ç½‘å…³ä¾§å¯¹å¼‚å¸¸apiserveræŠ“åŒ…" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5rru2fvj31jl0u0ai8.jpg"
        data-srcset="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5rru2fvj31jl0u0ai8.jpg, https://tva1.sinaimg.cn/large/008i3skNgy1gzc5rru2fvj31jl0u0ai8.jpg 1.5x, https://tva1.sinaimg.cn/large/008i3skNgy1gzc5rru2fvj31jl0u0ai8.jpg 2x"
        data-sizes="auto"
        alt="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5rru2fvj31jl0u0ai8.jpg"
        title="ç½‘å…³ä¾§å¯¹æ­£å¸¸apiserveræŠ“åŒ…" /></p>
<p>æ­¤æ—¶è§‚å¯Ÿåˆ°å®¢æˆ·ç«¯ watch è¯·æ±‚ Hang ä½ï¼ŒåŒæ—¶å‡ºç°äº† 503, å¤ç°äº†æ•…éšœæœŸé—´ watch è¯·æ±‚ä¸æ–­å¼€çš„åœºæ™¯ã€‚</p>
<h3 id="æ’æŸ¥">æ’æŸ¥</h3>
<p>æ­¤æ—¶æ ¹æ®ä¸Šè¿°ç°åœºæ·±æŒ–ä¿¡æ¯ï¼Œå‘ç°<strong>æ­£å¸¸çš„ apiserver æŠ“åŒ…çœ‹åˆ°å¹¶æ²¡æœ‰æ”¶åˆ°æ–°è¯·æ±‚</strong>ï¼ŒåŒæ—¶å¼‚å¸¸çš„ apiserver å¤„äºä¸¢åŒ…çŠ¶æ€æ— æ³•å¤„ç†è¯·æ±‚ï¼Œå³ä»ç½‘å…³ä¾§è¿æ¥åç«¯2ä¸ª apiserver å‡&quot;å¼‚å¸¸&quot;äº†, æ•…å®¢æˆ·ç«¯ watch è¯·æ±‚å¿…ç„¶å‡ºç°å¼‚å¸¸ã€‚</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5rx04drj31cq0u0qf8.jpg"
        data-srcset="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5rx04drj31cq0u0qf8.jpg, https://tva1.sinaimg.cn/large/008i3skNgy1gzc5rx04drj31cq0u0qf8.jpg 1.5x, https://tva1.sinaimg.cn/large/008i3skNgy1gzc5rx04drj31cq0u0qf8.jpg 2x"
        data-sizes="auto"
        alt="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5rx04drj31cq0u0qf8.jpg"
        title="å®¢æˆ·ç«¯client-goæ—¥å¿—ä¿¡æ¯" /></p>
<p>æ­¤æ—¶è§‚å¯Ÿåˆ°æœ¬åœ°å®¢æˆ·ç«¯çš„ 4 å±‚ tcp è¿æ¥å¦‚ä¸‹ (src port: 49739)ï¼Œ ç«¯å£æœªæ”¹å˜è¿‡ï¼Œè¯´æ˜å®¢æˆ·ç«¯ -&gt; ingress çš„ tcp è¿æ¥æœªæ–­å¼€è¿‡ã€‚</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5s01onyj324o0543zm.jpg"
        data-srcset="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5s01onyj324o0543zm.jpg, https://tva1.sinaimg.cn/large/008i3skNgy1gzc5s01onyj324o0543zm.jpg 1.5x, https://tva1.sinaimg.cn/large/008i3skNgy1gzc5s01onyj324o0543zm.jpg 2x"
        data-sizes="auto"
        alt="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5s01onyj324o0543zm.jpg"
        title="æœ¬åœ°netstatæˆªå›¾" /></p>
<p>äºæ˜¯æˆ‘æ€€ç–‘è¯·æ±‚ä»ç„¶èµ°çš„è€è¿æ¥æ‰“åˆ°äº†å¼‚å¸¸ apiserver ä¸Šï¼Œç½‘å…³ä¾§æ²¡æœ‰åšåˆ‡æ¢ï¼Œå°†è®¿é—® apiserver çš„è¯·æ±‚è·¯ç”±åˆ°æœªä¸¢åŒ…çš„ apiserver ä¸Š</p>
<h3 id="æ‰¾è§£å†³æ–¹æ¡ˆ">æ‰¾è§£å†³æ–¹æ¡ˆ</h3>
<p>æ ¹æ®ä¸Šè¿°ç–‘ç‚¹ï¼Œæˆ‘å‘ç°ç½‘å…³è®¿é—®æ–°çš„ apiserver ä»ç„¶æ˜¯èƒ½é€šçš„ï¼Œåªæ˜¯å®¢æˆ·ç«¯ watch è¯·åœ¨äºç½‘å…³æœªæ–­å¼€çš„æƒ…å†µä¸‹ä»ä½¿ç”¨äº†è€çš„ apiserver çš„è¿æ¥ï¼Œæ²¡æœ‰ä½¿ç”¨åˆ°è¿™æ ¹æ–°è¿æ¥ä¸Šã€‚</p>
<p>äºæ˜¯è§£å†³æ–¹æ¡ˆçš„æ€è·¯å¤§è‡´ä¸ºï¼š<strong>å¦‚ä½•è®©å®¢æˆ·ç«¯æ–­å¼€å¼‚å¸¸çš„ apiserver è¿æ¥å¹¶è¿ä¸Šæ–°çš„ apiserver ã€‚</strong></p>
<p>ç”±äºåœ¨æˆ‘ä»¬çš„é“¾è·¯ä¸‹ï¼Œå®¢æˆ·ç«¯ä¸ç›´æ¥å’Œ apiserver é€šè®¯ï¼Œè€Œæ˜¯ç”±ç½‘å…³è¿›è¡Œä»£ç†ï¼Œæ•…é—®é¢˜è½¬ç§»åˆ°äº†å¦‚ä½•åœ¨ç½‘å…³ä¸Šæ‰¾åˆ°æ–¹å¼é€šçŸ¥å®¢æˆ·ç«¯è¿›è¡Œé‡è¿ã€‚è°ƒç ”åå¾—åˆ°ä»¥ä¸‹ä¸¤ç§æ–¹æ¡ˆï¼š</p>
<ul>
<li>æ–¹æ¡ˆ1ï¼šåœ¨ç½‘å…³ä¾§é…ç½® <code>stream_idle_timeout</code> å‚æ•°, ç”±äºå®¢æˆ·ç«¯ä¸ç½‘å…³åœ¨è¯¥å¼‚å¸¸ä¸‹é•¿æ—¶é—´æ²¡æœ‰ http2 çš„åŒ…ä¼ è¾“ï¼Œæ•…å¿…ç„¶ä¸ä¼šæœ‰ h2 streamï¼Œé‚£ä¹ˆä½¿ç”¨è¯¥å‚æ•°æ¥ä½¿å¾—ç½‘å…³ä¾§ä¸»åŠ¨æ–­å¼€æ²¡æœ‰åŒ…ä¼ è¾“çš„è€è¿æ¥ï¼Œè§¦å‘å®¢æˆ·ç«¯é‡è¿æ–°è¿æ¥ã€‚</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5s1x0quj31g80l6dle.jpg"
        data-srcset="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5s1x0quj31g80l6dle.jpg, https://tva1.sinaimg.cn/large/008i3skNgy1gzc5s1x0quj31g80l6dle.jpg 1.5x, https://tva1.sinaimg.cn/large/008i3skNgy1gzc5s1x0quj31g80l6dle.jpg 2x"
        data-sizes="auto"
        alt="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5s1x0quj31g80l6dle.jpg"
        title="è§£å†³æ–¹æ¡ˆ1" /></p>
<ul>
<li>æ–¹æ¡ˆ2ï¼šç½‘å…³ä¾§é€šè¿‡ tcpKeepalive ææ–­ä¸å¼‚å¸¸ apiserver(é…ç½®äº†ä¸¢åŒ…è§„åˆ™) è¿æ¥ï¼Œä½¿å¾—å®¢æˆ·ç«¯é‡è¿ã€‚</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5s4aa3oj31c80jo79n.jpg"
        data-srcset="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5s4aa3oj31c80jo79n.jpg, https://tva1.sinaimg.cn/large/008i3skNgy1gzc5s4aa3oj31c80jo79n.jpg 1.5x, https://tva1.sinaimg.cn/large/008i3skNgy1gzc5s4aa3oj31c80jo79n.jpg 2x"
        data-sizes="auto"
        alt="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5s4aa3oj31c80jo79n.jpg"
        title="è§£å†³æ–¹æ¡ˆ2" /></p>
<h3 id="éªŒè¯">éªŒè¯</h3>
<p>æˆ‘é¦–å…ˆéªŒè¯äº†æ–¹æ¡ˆ1 &mdash;- <code>stream_idle_timeout</code> çš„æ–¹å¼ï¼Œå¢åŠ å¦‚ä¸‹ envoyFilter é…ç½®ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.istio.io/v1alpha3</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">EnvoyFilter</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ef-enable-stream-idle-timeout</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">istio-system</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">configPatches</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">applyTo</span><span class="p">:</span><span class="w"> </span><span class="l">NETWORK_FILTER</span><span class="w">
</span><span class="w">    </span><span class="nt">match</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">listener</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">filterChain</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">filter</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">envoy.http_connection_manager</span><span class="w">
</span><span class="w">    </span><span class="nt">patch</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">operation</span><span class="p">:</span><span class="w"> </span><span class="l">MERGE</span><span class="w">
</span><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">envoy.http_connection_manager</span><span class="w">
</span><span class="w">        </span><span class="nt">typed_config</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">&#34;@type&#34;: </span><span class="l">type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager</span><span class="w">
</span><span class="w">          </span><span class="nt">stream_idle_timeout</span><span class="p">:</span><span class="w"> </span><span class="l">600s</span><span class="w"> </span><span class="c"># 10mins, must be disabled for long-lived and streaming requests</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>ç½‘å…³ç¡®å®èƒ½ææ‰å¼‚å¸¸è¿æ¥äº†ï¼Œä½†ä¹Ÿä¼šææ‰ exec è¿™ç±»å®¢æˆ·ç«¯ç™»å½•å®¹å™¨çš„&quot;æ­£å¸¸è¿æ¥&quot;ï¼Œå³ä¸šåŠ¡æ–¹å­˜åœ¨éœ€è¦é€šè¿‡å’Œ apiserver å»ºç«‹ exec é•¿è¿æ¥ä¸”é•¿æ—¶é—´ä¸ä¼šå‘é€æ•°æ®åŒ…çš„æƒ…å†µã€‚åŠ ä¸Š <code>stream_idle_timeout</code> ä¼šè¯¯ææ‰è¿™äº›è¿æ¥ï¼Œå¯¹ä¸šåŠ¡æ˜¯æœ‰æŸçš„ï¼Œäºæ˜¯æ”¾å¼ƒäº†æ–¹æ¡ˆä¸€ã€‚</p>
<p>æ¥ç€æˆ‘å¼€å§‹éªŒè¯æ–¹æ¡ˆ2ï¼Œä¿®æ”¹ apiserver destinationRule é…ç½®ï¼Œå¢åŠ  tcpKeepalive</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5s8d0h3j30gu0buaar.jpg"
        data-srcset="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5s8d0h3j30gu0buaar.jpg, https://tva1.sinaimg.cn/large/008i3skNgy1gzc5s8d0h3j30gu0buaar.jpg 1.5x, https://tva1.sinaimg.cn/large/008i3skNgy1gzc5s8d0h3j30gu0buaar.jpg 2x"
        data-sizes="auto"
        alt="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5s8d0h3j30gu0buaar.jpg"
        title="tcpKeepaliveå‚æ•°é…ç½®" /></p>
<p>æ¥ç€æŒ‰ç…§ä¸¢åŒ…çš„æ–¹æ¡ˆé‡æ–°å¯åŠ¨æœ¬åœ°æµ‹è¯• client è¿›è¡ŒéªŒè¯</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5s6kn0ej315q0mywm9.jpg"
        data-srcset="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5s6kn0ej315q0mywm9.jpg, https://tva1.sinaimg.cn/large/008i3skNgy1gzc5s6kn0ej315q0mywm9.jpg 1.5x, https://tva1.sinaimg.cn/large/008i3skNgy1gzc5s6kn0ej315q0mywm9.jpg 2x"
        data-sizes="auto"
        alt="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5s6kn0ej315q0mywm9.jpg"
        title="æ„ŸçŸ¥åˆ°æŠ¥é”™çš„å®¢æˆ·ç«¯æ—¥å¿—" /></p>
<p>è§‚å¯Ÿå‘ç°å®¢æˆ·ç«¯åœ¨ä¸‹ä¸€æ¬¡ relist(ListAndWatch) åæ¢å¤æ­£å¸¸</p>
<p>åŒæ—¶å†æ¬¡åœ¨æœ¬åœ°æŸ¥çœ‹å®¢æˆ·ç«¯ç«¯å£ä¸º 49739, 4 å±‚ tcp è¿æ¥æœªæ–­å¼€ï¼Œè¯´æ˜å®¢æˆ·ç«¯ -&gt; ingress é“¾è·¯æ­£å¸¸.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5sgzr78j324q0aywgy.jpg"
        data-srcset="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5sgzr78j324q0aywgy.jpg, https://tva1.sinaimg.cn/large/008i3skNgy1gzc5sgzr78j324q0aywgy.jpg 1.5x, https://tva1.sinaimg.cn/large/008i3skNgy1gzc5sgzr78j324q0aywgy.jpg 2x"
        data-sizes="auto"
        alt="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5sgzr78j324q0aywgy.jpg"
        title="æ„ŸçŸ¥åˆ°æŠ¥é”™çš„å®¢æˆ·ç«¯netstatæˆªå›¾" /></p>
<p>è¿›ä¸€æ­¥ä½è¯äº†é—®é¢˜å¯èƒ½æ˜¯ ingress è¿ä¸Šäº†ä¸å¯ç”¨çš„ apiserverï¼Œè€ŒåŠ ä¸Š tcpKeepalive åˆ™è®©ç½‘å…³æ£€æŸ¥åˆ° apiserver ä¸å¯ç”¨(ä»…ç½‘ç»œå±‚)ï¼Œä»è€Œåˆ‡æ¢åˆ°å¦ä¸€ä¸ªå¯ç”¨çš„ apiserver å®ä¾‹ã€‚</p>
<h3 id="æ ¹æ®-pprof-è¿›è¡Œç»“è®ºçš„äºŒæ¬¡éªŒè¯">æ ¹æ® pprof è¿›è¡Œç»“è®ºçš„äºŒæ¬¡éªŒè¯</h3>
<p>ç”±äºç›®å‰æ‰€ä½¿ç”¨çš„ client-go ä»£ç ä¸­å¢åŠ äº† watchTimeout çš„é€»è¾‘ï¼Œä¼šå‘¨æœŸæ€§åœ°è¿›è¡Œ relist&amp;watch, ä»è€Œä¿éšœ watch è¯·æ±‚ä¸ä¼šé•¿æ—¶é—´ hang ä½</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5sj9vobj324k0ae0uu.jpg"
        data-srcset="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5sj9vobj324k0ae0uu.jpg, https://tva1.sinaimg.cn/large/008i3skNgy1gzc5sj9vobj324k0ae0uu.jpg 1.5x, https://tva1.sinaimg.cn/large/008i3skNgy1gzc5sj9vobj324k0ae0uu.jpg 2x"
        data-sizes="auto"
        alt="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5sj9vobj324k0ae0uu.jpg"
        title="client-go watchTimeout ä»£ç æ®µ1" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5sln9z3j324q0kq456.jpg"
        data-srcset="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5sln9z3j324q0kq456.jpg, https://tva1.sinaimg.cn/large/008i3skNgy1gzc5sln9z3j324q0kq456.jpg 1.5x, https://tva1.sinaimg.cn/large/008i3skNgy1gzc5sln9z3j324q0kq456.jpg 2x"
        data-sizes="auto"
        alt="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5sln9z3j324q0kq456.jpg"
        title="client-go watchTimeout ä»£ç æ®µ2" /></p>
<p>æ•…æ­£å¸¸æƒ…å†µä¸‹ client-go watch è¯·æ±‚è¡Œä¸ºå¦‚ä¸‹:</p>
<ul>
<li><strong>é¢„æœŸ</strong>: åœ¨æ¯æ¬¡è°ƒç”¨ <code>ListAndWatch</code> çš„æ—¶é—´çª—å£(5-10åˆ†é’Ÿå†…)æœªæ¥æ”¶åˆ°è¯·æ±‚ï¼Œåˆ™ä¼šè‡ªåŠ¨æ–­å¼€ï¼Œè¿›è¡Œ relist</li>
</ul>
<p>åœ¨æœªå¼€å¯ tcpKeepalive å‰ï¼Œå‡ºç°äº† watchHandler goroutine hang ä½é—®é¢˜, è§‚å¯Ÿä¸‹å›¾ pprof ä¸­ goroutine stack å‘ç°ï¼ŒwatchHandler è¿™ä¸ª goroutine è¿è¡Œäº†è¶…è¿‡ 10minï¼Œæœªè§¦å‘ client-go ä¸­ relist é€»è¾‘, ä¸ç¬¦åˆé¢„æœŸã€‚å±äº watch hang ä½è¡Œä¸ºã€‚</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5so5elfj31jg0u07hd.jpg"
        data-srcset="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5so5elfj31jg0u07hd.jpg, https://tva1.sinaimg.cn/large/008i3skNgy1gzc5so5elfj31jg0u07hd.jpg 1.5x, https://tva1.sinaimg.cn/large/008i3skNgy1gzc5so5elfj31jg0u07hd.jpg 2x"
        data-sizes="auto"
        alt="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5so5elfj31jg0u07hd.jpg"
        title="æœ¬åœ°pprofæˆªå›¾" /></p>
<p>è€Œå¼€å¯ tcpKeepalive åï¼ŒwatchHandler goroutine hang ä½é—®é¢˜æ¶ˆå¤±ï¼ŒwatchHandler å‡ä¸è¶…è¿‡ 5minï¼Œç¬¦åˆé¢„æœŸã€‚watch hang ä½é—®é¢˜æ¶ˆå¤±ã€‚</p>
<h2 id="é—®é¢˜æ ¹å› ">é—®é¢˜æ ¹å› </h2>
<p>å®šä½åˆ°äº† tcpKeepalive èƒ½è§£è¿™ä¸ªé—®é¢˜åï¼Œå’±å¼€å§‹æ€€ç–‘è¿™ä¸ªå‚æ•°çš„åº•å±‚é€»è¾‘æ˜¯å•¥ï¼Œä¸ºå•¥èƒ½è§£è¿™ä¸ªé—®é¢˜ã€‚</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://robberphex.com/how-to-inspect-kubernetes-api/capture-architecture.png"
        data-srcset="https://robberphex.com/how-to-inspect-kubernetes-api/capture-architecture.png, https://robberphex.com/how-to-inspect-kubernetes-api/capture-architecture.png 1.5x, https://robberphex.com/how-to-inspect-kubernetes-api/capture-architecture.png 2x"
        data-sizes="auto"
        alt="https://robberphex.com/how-to-inspect-kubernetes-api/capture-architecture.png"
        title="charles k8sæŠ“åŒ…é“¾è·¯" /></p>
<p>ç”±äºè¿™ä¸ªå‚æ•°æ˜¯ä½œç”¨åœ¨ç½‘ç»œ 4 å±‚ï¼Œäºæ˜¯æˆ‘ç¬¬ä¸€æƒ³æ³•æ˜¯è¿›è¡ŒæŠ“åŒ…æ‹¿æ›´å¤šä¿¡æ¯ã€‚å‚è€ƒä¸Šå›¾çš„æŠ“åŒ…é“¾è·¯ï¼Œæˆ‘å¯åŠ¨äº† charles è¿›è¡Œ k8s apiserver https æŠ“åŒ…ã€‚</p>
<p>è§‚å¯Ÿå‘ç°æœªå¼€å¯ tcpKeepalive æ—¶ï¼Œå¼‚å¸¸æ—¶(ingress ä¾§å¼€å¯äº†å•å° apiserver ä¸¢åŒ…) ï¼Œå®¢æˆ·ç«¯çš„ watch è¯·æ±‚ Tcp/Http è¿æ¥å‡ä¸æ–­å¼€ã€‚è€Œå¼€å¯ tcpKeepalive åï¼Œå½“ç½‘å…³è®¿é—®åˆ°é…ç½®äº†ä¸¢åŒ…è§„åˆ™çš„ apiserver æ—¶å‡ºç°äº† 503, å¹¶è¿”å›é”™è¯¯ç»™å®¢æˆ·ç«¯, åŒæ—¶å®¢æˆ·ç«¯çš„7å±‚è¿æ¥è¿›è¡Œé‡å»º(streamId å˜äº†)ï¼Œé‡å»ºåä¸‹ä¸€æ¬¡ <code>ListAndWatch</code> è¯·æ±‚å¯ä»¥æ­£å¸¸æ‹¿åˆ°å“åº”ã€‚</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5szlzjcj31c30u0tcq.jpg"
        data-srcset="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5szlzjcj31c30u0tcq.jpg, https://tva1.sinaimg.cn/large/008i3skNgy1gzc5szlzjcj31c30u0tcq.jpg 1.5x, https://tva1.sinaimg.cn/large/008i3skNgy1gzc5szlzjcj31c30u0tcq.jpg 2x"
        data-sizes="auto"
        alt="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5szlzjcj31c30u0tcq.jpg"
        title="charles æœ¬åœ°æŠ“åŒ…æˆªå›¾1" /></p>
<p>æ‰€ä»¥æ˜¯ä»€ä¹ˆå¯¼è‡´äº†è¿™ä¸ªè¡Œä¸ºå‘¢ï¼Ÿ</p>
<p>ç”±äº charles åªèƒ½æŠ“å– 7 å±‚çš„æ•°æ®åŒ…ï¼Œæˆ‘æƒ³çœ‹çœ‹ 4 å±‚çš„ç½‘ç»œè¡Œä¸ºï¼Œä¾è‘«èŠ¦ç”»ç“¢ï¼Œå†æ¬¡é€šè¿‡ wireshark æŠ“åŒ…</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5t30skyj31fw0u0wm2.jpg"
        data-srcset="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5t30skyj31fw0u0wm2.jpg, https://tva1.sinaimg.cn/large/008i3skNgy1gzc5t30skyj31fw0u0wm2.jpg 1.5x, https://tva1.sinaimg.cn/large/008i3skNgy1gzc5t30skyj31fw0u0wm2.jpg 2x"
        data-sizes="auto"
        alt="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5t30skyj31fw0u0wm2.jpg"
        title="wiresharkè§£åŒ…æˆªå›¾1" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5t5t2z2j31gc0u0do9.jpg"
        data-srcset="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5t5t2z2j31gc0u0do9.jpg, https://tva1.sinaimg.cn/large/008i3skNgy1gzc5t5t2z2j31gc0u0do9.jpg 1.5x, https://tva1.sinaimg.cn/large/008i3skNgy1gzc5t5t2z2j31gc0u0do9.jpg 2x"
        data-sizes="auto"
        alt="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5t5t2z2j31gc0u0do9.jpg"
        title="wiresharkè§£åŒ…æˆªå›¾2" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5t8lllrj31gf0u0dog.jpg"
        data-srcset="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5t8lllrj31gf0u0dog.jpg, https://tva1.sinaimg.cn/large/008i3skNgy1gzc5t8lllrj31gf0u0dog.jpg 1.5x, https://tva1.sinaimg.cn/large/008i3skNgy1gzc5t8lllrj31gf0u0dog.jpg 2x"
        data-sizes="auto"
        alt="https://tva1.sinaimg.cn/large/008i3skNgy1gzc5t8lllrj31gf0u0dog.jpg"
        title="wiresharkæŠ“åŒ…æˆªå›¾3" /></p>
<p>å‘ç°åœ¨å¼€å¯ç½‘å…³ä¾§ tcpKeepalive åï¼Œç½‘å…³ä¾§è®¿é—®å¼‚å¸¸ apiserver å¤±è´¥ï¼Œåœ¨ç½‘å…³èŠ‚ç‚¹ä¸Šææ–­äº†ä¸å¼‚å¸¸ apiserver çš„ï¼ŒåŒæ—¶å®¢æˆ·ç«¯åœ¨ä¸ç½‘å…³çš„ 60s tcpkeepalive timeout åï¼Œç½‘å…³ä¾§ä¸»åŠ¨å‘å®¢æˆ·ç«¯å‘é€äº†ä¸€æ¡æŠ¥æ–‡ï¼Œè§¦å‘äº†å®¢æˆ·ç«¯é‡å»º7å±‚è¿æ¥ï¼Œå®¢æˆ·ç«¯åœ¨è¿æ¥é‡å»ºåæ¢å¤æ­£å¸¸ï¼Œè§‚å¯Ÿå‘ç°è¯·æ±‚æ‰“åˆ°äº†å¦å¤–ä¸€å°æ­£å¸¸çš„ apiserver ä¸Šã€‚</p>
<h2 id="æ€è€ƒ">æ€è€ƒ</h2>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://tva1.sinaimg.cn/large/008i3skNgy1gzc7935v52j308c04o0so.jpg"
        data-srcset="https://tva1.sinaimg.cn/large/008i3skNgy1gzc7935v52j308c04o0so.jpg, https://tva1.sinaimg.cn/large/008i3skNgy1gzc7935v52j308c04o0so.jpg 1.5x, https://tva1.sinaimg.cn/large/008i3skNgy1gzc7935v52j308c04o0so.jpg 2x"
        data-sizes="auto"
        alt="https://tva1.sinaimg.cn/large/008i3skNgy1gzc7935v52j308c04o0so.jpg"
        title="client-go-goodorbad" />
client-go ä¸­çš„ watchTimeout æ˜¯ä¾é  apiserver ä¸»åŠ¨å‘èµ·æ‰èƒ½è¿›è¡Œ relistï¼Œåœ¨ä¸Šè¿°ä¸¢åŒ…åœºæ™¯ä¸‹ï¼Œapiserver æ— æ³•å›åŒ…ï¼Œæ•… watch è¿æ¥ hang ä½çš„é—®é¢˜åœ¨ client-go è‡ªèº«çš„æœºåˆ¶æ˜¯æ— æ³•ä¿è¯èƒ½è‡ªæ„ˆçš„ï¼Œæ•…åœ¨æ•´æ¡ apiserver è®¿é—®è¿ä¸Šä¸Šï¼Œéœ€è¦åŠ ä¸Šå¥åº·æ£€æŸ¥/æ¢æ´»é€»è¾‘(å¦‚ istio ingressgateway å¯¹ apiserver çš„æ¢æ´»)ï¼Œæ‰èƒ½ä¿è¯ watch è¯·æ±‚å¯é æ€§ã€‚</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2022-02-13</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/k8s-api-watch-hang-dignosis/index.md" target="_blank">Read Markdown</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://example.com/k8s-api-watch-hang-dignosis/" data-title="è®°ä¸€æ¬¡ k8s apiserver watch hang é—®é¢˜æ’æŸ¥" data-via="lexuscyborg103" data-hashtags="Kubernetes,Linux"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="Share on å¾®åš" data-sharer="weibo" data-url="https://example.com/k8s-api-watch-hang-dignosis/" data-title="è®°ä¸€æ¬¡ k8s apiserver watch hang é—®é¢˜æ’æŸ¥"><i class="fab fa-weibo fa-fw"></i></a><a href="javascript:void(0);" title="Share on Evernote" data-sharer="evernote" data-url="https://example.com/k8s-api-watch-hang-dignosis/" data-title="è®°ä¸€æ¬¡ k8s apiserver watch hang é—®é¢˜æ’æŸ¥"><i class="fab fa-evernote fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/kubernetes/">Kubernetes</a>,&nbsp;<a href="/tags/linux/">Linux</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/its-ok-douban/" class="prev" rel="prev" title="è±†ç“£ï¼Œçº·çº·æ‰°æ‰°æ— å…³"><i class="fas fa-angle-left fa-fw"></i>è±†ç“£ï¼Œçº·çº·æ‰°æ‰°æ— å…³</a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2015 - 2022</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">LexusLee</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/css/lightgallery.min.css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/algoliasearch@4.2.0/dist/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/js/lightgallery.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lg-zoom.js@1.2.0/dist/lg-zoom.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":10},"comment":{},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"search":{"algoliaAppID":"PASDMWALPK","algoliaIndex":"index.en","algoliaSearchKey":"b42948e51daaa93df92381c8e2ac0f93","highlightTag":"em","maxResultLength":10,"noResultsFound":"No results found","snippetLength":30,"type":"algolia"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
