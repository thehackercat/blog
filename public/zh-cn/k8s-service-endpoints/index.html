<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>浅谈 k8s service&amp;kube-proxy - LexusLee&#39;s blog</title><meta name="Description" content="LexusLee personal blog, recording things you people wouldn&#39;t believe. Like attack ships on fire off the shoulder of Orion, c-beams glitter in the dark near the Tannhauser Gate."><meta property="og:title" content="浅谈 k8s service&amp;kube-proxy" />
<meta property="og:description" content="Lexus Lee
背景
最开始听到同事 k8s 分享时比较困惑我的一个问题是 k8s 怎么实现一个私有 ip(虚拟 ip，以下简称 vip)到另一个私有ip收发包的。
不过其实我想知道的应该是 k8s 通信机制，它是怎么实现服务发现的，新建的 pod 是怎么感知到的，万一有些 pod 节点变更 vip 变了 k8s 是如何感知的。
基于这个问题，做一下关于 k8s service&amp;kube-proxy 的分享。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://example.com/zh-cn/k8s-service-endpoints/" />
<meta property="og:image" content="https://example.com/logo.png"/>
<meta property="article:published_time" content="2018-09-14T19:10:46+00:00" />
<meta property="article:modified_time" content="2020-07-14T02:57:28+08:00" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://example.com/logo.png"/>

<meta name="twitter:title" content="浅谈 k8s service&amp;kube-proxy"/>
<meta name="twitter:description" content="Lexus Lee
背景
最开始听到同事 k8s 分享时比较困惑我的一个问题是 k8s 怎么实现一个私有 ip(虚拟 ip，以下简称 vip)到另一个私有ip收发包的。
不过其实我想知道的应该是 k8s 通信机制，它是怎么实现服务发现的，新建的 pod 是怎么感知到的，万一有些 pod 节点变更 vip 变了 k8s 是如何感知的。
基于这个问题，做一下关于 k8s service&amp;kube-proxy 的分享。"/>
<meta name="application-name" content="LexusLee&#39;s blog">
<meta name="apple-mobile-web-app-title" content="LexusLee&#39;s blog"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://example.com/zh-cn/k8s-service-endpoints/" /><link rel="prev" href="https://example.com/zh-cn/scarllet-sql-attack/" /><link rel="next" href="https://example.com/zh-cn/kubeproxy-ipvs-accident/" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "浅谈 k8s service\u0026kube-proxy",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/example.com\/zh-cn\/k8s-service-endpoints\/"
        },"image": ["https:\/\/example.com\/images\/Apple-Devices-Preview.png"],"genre": "posts","keywords": "Golang, Kubernetes, Linux","wordcount":  2448 ,
        "url": "https:\/\/example.com\/zh-cn\/k8s-service-endpoints\/","datePublished": "2018-09-14T19:10:46+00:00","dateModified": "2020-07-14T02:57:28+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "LexusLee","logo": {
                    "@type": "ImageObject",
                    "url": "https:\/\/example.com\/images\/avatar.png",
                    "width":  552 ,
                    "height":  608 
                }},"author": {
                "@type": "Person",
                "name": "LexusLee"
            },"description": ""
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/zh-cn/" title="LexusLee&#39;s blog"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span>Nice to meet you</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/zh-cn/posts/"> 所有文章 </a><a class="menu-item" href="/zh-cn/tags/"> 标签 </a><a class="menu-item" href="/zh-cn/categories/"> 分类 </a><a class="menu-item" href="/zh-cn/categories/documentation/"> 文档 </a><a class="menu-item" href="/zh-cn/about/"> 关于 </a><a class="menu-item" href="https://github.com/dillonzq/LoveIt" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item language" title="选择语言">简体中文<i class="fas fa-chevron-right fa-fw"></i>
                        <select class="language-select" id="language-select-desktop" onchange="location = this.value;"><option value="/k8s-service-endpoints/">English</option><option value="/zh-cn/k8s-service-endpoints/" selected>简体中文</option></select>
                    </a><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/zh-cn/" title="LexusLee&#39;s blog"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span>Nice to meet you</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/zh-cn/posts/" title="">所有文章</a><a class="menu-item" href="/zh-cn/tags/" title="">标签</a><a class="menu-item" href="/zh-cn/categories/" title="">分类</a><a class="menu-item" href="/zh-cn/categories/documentation/" title="">文档</a><a class="menu-item" href="/zh-cn/about/" title="">关于</a><a class="menu-item" href="https://github.com/dillonzq/LoveIt" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a><a href="javascript:void(0);" class="menu-item" title="选择语言">简体中文<i class="fas fa-chevron-right fa-fw"></i>
                    <select class="language-select" onchange="location = this.value;"><option value="/k8s-service-endpoints/">English</option><option value="/zh-cn/k8s-service-endpoints/" selected>简体中文</option></select>
                </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">浅谈 k8s service&amp;kube-proxy</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>LexusLee</a></span>&nbsp;<span class="post-category">收录于 <a href="/zh-cn/categories/code/"><i class="far fa-folder fa-fw"></i>Code</a>&nbsp;<a href="/zh-cn/categories/kubernetes/"><i class="far fa-folder fa-fw"></i>Kubernetes</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2018-09-14">2018-09-14</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 2448 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 5 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#背景">背景</a></li>
        <li><a href="#servicekube-proxy-概述">Service&amp;kube-proxy 概述</a></li>
        <li><a href="#kube-proxy-源码分析">kube-proxy 源码分析</a></li>
        <li><a href="#最后">最后</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><div style="text-align: right;">Lexus Lee</div>
<h3 id="背景">背景</h3>
<p>最开始听到同事 k8s 分享时比较困惑我的一个问题是 k8s 怎么实现一个私有 ip(虚拟 ip，以下简称 vip)到另一个私有ip收发包的。</p>
<p>不过其实我想知道的应该是 k8s 通信机制，它是怎么实现服务发现的，新建的 pod 是怎么感知到的，万一有些 pod 节点变更 vip 变了 k8s 是如何感知的。</p>
<p>基于这个问题，做一下关于 k8s service&amp;kube-proxy 的分享。</p>
<h3 id="servicekube-proxy-概述">Service&amp;kube-proxy 概述</h3>
<p>首先我建了一个 <code>replcas = 4</code>  <code>lebel: app=service_test_pod</code>的 python server deployment 来打出当前 pod 的 Hostname</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="k">apiVersion</span><span class="p">:</span><span class="w">  </span>apps/v1<span class="w">
</span><span class="w"></span><span class="k">kind</span><span class="p">:</span><span class="w"> </span>Deployment<span class="w">
</span><span class="w"></span><span class="k">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>service-test<span class="w">
</span><span class="w"></span><span class="k">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">4</span><span class="w">
</span><span class="w">  </span><span class="k">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">app</span><span class="p">:</span><span class="w"> </span>service_test_pod<span class="w">
</span><span class="w">  </span><span class="k">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="k">app</span><span class="p">:</span><span class="w"> </span>service_test_pod<span class="w">
</span><span class="w">    </span><span class="k">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>simple-http<span class="w">
</span><span class="w">        </span><span class="k">image</span><span class="p">:</span><span class="w"> </span>python<span class="p">:</span><span class="m">2.7</span><span class="w">
</span><span class="w">        </span><span class="k">imagePullPolicy</span><span class="p">:</span><span class="w"> </span>IfNotPresent<span class="w">
</span><span class="w">        </span><span class="k">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;/bin/bash&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">        </span><span class="k">args</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;-c&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;echo \&#34;&lt;p&gt;Hello from $(hostname)&lt;/p&gt;\&#34; &gt; index.html; python -m SimpleHTTPServer 9999&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">        </span><span class="k">ports</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>http<span class="w">
</span><span class="w">          </span><span class="k">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">9999</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>可以看到启动了4个 pod</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">service-test-69764ddb4c-4hr2x                                     1/1       Running             0          8s        172.18.234.21    brand6
service-test-69764ddb4c-gstft                                     1/1       Running             0          8s        172.18.83.225    belba2
service-test-69764ddb4c-nnv29                                     1/1       Running             0          8s        172.18.156.140   brand2
service-test-69764ddb4c-vx5pn                                     0/1       ContainerCreating   0          8s        &lt;none&gt;           belba3
</code></pre></td></tr></table>
</div>
</div><p>我必须挨个 curl 才能得到他们的 hostname</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">lilingzhi@belba1 ~/k8s/test $ curl 172.18.234.21:9999
&lt;p&gt;Hello from service-test-69764ddb4c-4hr2x&lt;/p&gt;
</code></pre></td></tr></table>
</div>
</div><p>但不能让其他 pod 直接通过 vip 访问这些 pod ，需要一个更上层的一个抽象，把这4个提供相同服务的 pod 打包成一个对外的服务，通过某个入口地址来访问它，并且把请求均衡到4个pod上，这样一层的抽象包装是实现一个服务网络(service mesh)的基础。</p>
<p>而 k8s service 就是做这个的。</p>
<p>首先我们来看下什么是 k8s service:</p>
<blockquote>
<ul>
<li>A Kubernetes <code>Service</code> is an abstraction which defines a logical set of <code>Pods</code> and a policy by which to access them - sometimes called a micro-service. The set of <code>Pods</code> targeted by a <code>Service</code> is (usually) determined by a <a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/#label-selectors" target="_blank" rel="noopener noreffer"><code>Label Selector</code></a> (see below for why you might want a <code>Service</code> without a selector)</li>
</ul>
</blockquote>
<p>而打包pod成service并发布的微服务得支持 k8s 内部及外部的访问。</p>
<p>故 k8s service 提供了以下三种暴露 service 入口的模式:</p>
<blockquote>
<ul>
<li>ClusterIP: use a cluster-internal IP only - this is the default and is discussed above. Choosing this value means that you want this service to be reachable only from inside of the cluster.</li>
<li>NodePort: on top of having a cluster-internal IP, expose the service on a port on each node of the cluster (the same port on each node). You’ll be able to contact the service on any :NodePort address.</li>
<li>LoadBalancer: on top of having a cluster-internal IP and exposing service on a NodePort also, ask the cloud provider for a load balancer which forwards to the Service exposed as a :NodePort for each Node.</li>
</ul>
</blockquote>
<p>可以简单理解为 ClusterIp 是提供对内的访问入口，NodePort 和 LoadBalancer 是提供对外的，不过 LoadBalancer 是在暴露 NodePort 基础上提供可以接入外部的 LB。</p>
<p>那么我新建一个 service 给刚刚的 4 个 pod</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">lilingzhi@belba1 ~/k8s/test $ kubectl expose deployment service-test --type<span class="o">=</span><span class="s2">&#34;NodePort&#34;</span> --port <span class="m">9098</span> --target-port<span class="o">=</span><span class="m">9999</span>
service/service-test exposed
</code></pre></td></tr></table>
</div>
</div><p>可以看到</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">lilingzhi@belba1 ~/k8s/test $ kubectl get service -o wide
NAME                   TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>                               AGE       SELECTOR
service-test           NodePort    172.19.97.3     &lt;none&gt;        9098:30255/TCP                        16s       <span class="nv">app</span><span class="o">=</span>service_test_pod
</code></pre></td></tr></table>
</div>
</div><p><code>service-test</code> 这儿就映射到 clusterIp 的 172.19.97.3:9098 端口上</p>
<p>再看下 endpoints</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">lilingzhi@belba1 ~/k8s/test $ kubectl get endpoints -o wide
NAME                   ENDPOINTS                                                               AGE
service-test           172.18.156.140:9999,172.18.193.66:9999,172.18.234.21:9999 + <span class="m">1</span> more...   3m
</code></pre></td></tr></table>
</div>
</div><p>可以看到也建了一个包含 4个 host:port 的元组的 endpoint</p>
<p>通过不断 curl service ip:port 会发现请求已经均衡到4个 pod 上了</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">lilingzhi@belba1 ~/k8s/test $ curl 172.19.97.3:9098
&lt;p&gt;Hello from service-test-69764ddb4c-4hr2x&lt;/p&gt;
lilingzhi@belba1 ~/k8s/test $ curl 172.19.97.3:9098
&lt;p&gt;Hello from service-test-69764ddb4c-gstft&lt;/p&gt;
lilingzhi@belba1 ~/k8s/test $ curl 172.19.97.3:9098
&lt;p&gt;Hello from service-test-69764ddb4c-4hr2x&lt;/p&gt;
lilingzhi@belba1 ~/k8s/test $ curl 172.19.97.3:9098
&lt;p&gt;Hello from service-test-69764ddb4c-gstft&lt;/p&gt;
</code></pre></td></tr></table>
</div>
</div><p>由于 k8s service 路由是通过 kube-proxy 决定的，默认是走的 iptables 转发的(可换成用户态 proxy 或 ipvs)，所以查一下相应的 iptables 规则</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">$ sudo iptables -L -v -n -t nat

Chain KUBE-SERVICES <span class="o">(</span><span class="m">2</span> references<span class="o">)</span>
    <span class="m">0</span>     <span class="m">0</span> KUBE-MARK-MASQ  tcp  --  *      *      !172.18.0.0/16        172.19.97.3          /* default/service-test: cluster IP */ tcp dpt:9098
    <span class="m">0</span>     <span class="m">0</span> KUBE-SVC-LY73ZDGF4KGO4YFJ  tcp  --  *      *       0.0.0.0/0            172.19.97.3          /* default/service-test: cluster IP */ tcp dpt:9098

</code></pre></td></tr></table>
</div>
</div><p>看到有条 <code>chain KUBE-SVC-LY73ZDGF4KGO4YFJ</code> 定义了 service-test 的转发规则，于是查看相应的 chain</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">Chain KUBE-SVC-LY73ZDGF4KGO4YFJ <span class="o">(</span><span class="m">2</span> references<span class="o">)</span>
 pkts bytes target     prot opt in     out     <span class="nb">source</span>               destination
    <span class="m">0</span>     <span class="m">0</span> KUBE-SEP-2T6K76SEPIPV3QKW  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/service-test: */ statistic mode random probability 0.25000000000
    <span class="m">0</span>     <span class="m">0</span> KUBE-SEP-75XULILUFIHXBBLY  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/service-test: */ statistic mode random probability 0.33332999982
    <span class="m">0</span>     <span class="m">0</span> KUBE-SEP-FFUABGNOKSNXGH7E  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/service-test: */ statistic mode random probability 0.50000000000
    <span class="m">0</span>     <span class="m">0</span> KUBE-SEP-MKK3T4CLASKIDMJS  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/service-test: */
</code></pre></td></tr></table>
</div>
</div><p>可以看到这条 <code>KUBE-SVC-LY73ZDGF4KGO4YFJ</code> chain 里有4个下一跳的 chain <code>KUBE-SEP-2T6K76SEPIPV3QKW</code> ，<code>KUBE-SEP-75XULILUFIHXBBLY</code>, <code>KUBE-SEP-FFUABGNOKSNXGH7E</code>, <code>KUBE-SEP-MKK3T4CLASKIDMJS</code>, 他们分别对应4个 pod 的 vip，并且设置了 iptables probability, 由上至下分别为 <code>25%</code>, <code>33.33%</code>, <code>50%</code>, <code>100%</code>, 由于 iptables 是顺序读的，这样确保了每个 pod 都是 <code>25%</code> 的请求分发的机率。</p>
<p>那么我们挑其中一条子 chain <code>KUBE-SEP-2T6K76SEPIPV3QKW</code> 跟进去看看</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">Chain KUBE-SEP-2T6K76SEPIPV3QKW <span class="o">(</span><span class="m">1</span> references<span class="o">)</span>
 pkts bytes target     prot opt in     out     <span class="nb">source</span>               destination
    <span class="m">0</span>     <span class="m">0</span> KUBE-MARK-MASQ  all  --  *      *       172.18.156.140       0.0.0.0/0            /* default/service-test: */
    <span class="m">0</span>     <span class="m">0</span> DNAT       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/service-test: */ tcp to:172.18.156.140:9999
</code></pre></td></tr></table>
</div>
</div><p>果不其然，这儿的 source ip 就是对应 pod 的 vip, 一个请求就这样转发到 pod 上，可以看到一共要经过3层 chain。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="http://7xse6j.com1.z0.glb.clouddn.com/k8s_share2.png"
        data-srcset="http://7xse6j.com1.z0.glb.clouddn.com/k8s_share2.png, http://7xse6j.com1.z0.glb.clouddn.com/k8s_share2.png 1.5x, http://7xse6j.com1.z0.glb.clouddn.com/k8s_share2.png 2x"
        data-sizes="auto"
        alt="http://7xse6j.com1.z0.glb.clouddn.com/k8s_share2.png"
        title="chains" /></p>
<p>不过有二义性的地方在于，这儿的 kube-proxy 实际上并不起一个 proxy 的作用，而是 watch 变更并更新 iptables，也就是说，client 的请求直接通过 iptables 路由，所以如果我们直接修改 iptables 也是可以奏效的。</p>
<h3 id="kube-proxy-源码分析">kube-proxy 源码分析</h3>
<p>因为 kube-proxy 源码相对比较少，所以读了下源码，但还是蛮复杂的</p>
<p>kube-proxy 会作为 daemon 跑在每个节点上，对 api-server 中的 service &amp; endpoint 进行 watch ,一旦检测到更新则往 iptables 里全量推送新的转发规则，那么我们根据 <code>kubernetes/cmd/kube-proxy/proxy.go</code> 里找到 kube-proxy 真正的入口函数 <code>Run()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">ProxyServer</span><span class="p">)</span> <span class="nf">Run</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="o">...</span>
	<span class="nx">serviceConfig</span> <span class="o">:=</span> <span class="nx">config</span><span class="p">.</span><span class="nf">NewServiceConfig</span><span class="p">(</span><span class="nx">informerFactory</span><span class="p">.</span><span class="nf">Core</span><span class="p">().</span><span class="nf">V1</span><span class="p">().</span><span class="nf">Services</span><span class="p">(),</span> <span class="nx">s</span><span class="p">.</span><span class="nx">ConfigSyncPeriod</span><span class="p">)</span>
	<span class="nx">serviceConfig</span><span class="p">.</span><span class="nf">RegisterEventHandler</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">ServiceEventHandler</span><span class="p">)</span>
	<span class="k">go</span> <span class="nx">serviceConfig</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="nx">wait</span><span class="p">.</span><span class="nx">NeverStop</span><span class="p">)</span>

	<span class="nx">endpointsConfig</span> <span class="o">:=</span> <span class="nx">config</span><span class="p">.</span><span class="nf">NewEndpointsConfig</span><span class="p">(</span><span class="nx">informerFactory</span><span class="p">.</span><span class="nf">Core</span><span class="p">().</span><span class="nf">V1</span><span class="p">().</span><span class="nf">Endpoints</span><span class="p">(),</span> <span class="nx">s</span><span class="p">.</span><span class="nx">ConfigSyncPeriod</span><span class="p">)</span>
	<span class="nx">endpointsConfig</span><span class="p">.</span><span class="nf">RegisterEventHandler</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">EndpointsEventHandler</span><span class="p">)</span>
	<span class="k">go</span> <span class="nx">endpointsConfig</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="nx">wait</span><span class="p">.</span><span class="nx">NeverStop</span><span class="p">)</span>

	<span class="c1">// This has to start after the calls to NewServiceConfig and NewEndpointsConfig because those
</span><span class="c1"></span>	<span class="c1">// functions must configure their shared informer event handlers first.
</span><span class="c1"></span>	<span class="k">go</span> <span class="nx">informerFactory</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="nx">wait</span><span class="p">.</span><span class="nx">NeverStop</span><span class="p">)</span>

	<span class="c1">// Birth Cry after the birth is successful
</span><span class="c1"></span>	<span class="nx">s</span><span class="p">.</span><span class="nf">birthCry</span><span class="p">()</span>

	<span class="c1">// Just loop forever for now...
</span><span class="c1"></span>	<span class="nx">s</span><span class="p">.</span><span class="nx">Proxier</span><span class="p">.</span><span class="nf">SyncLoop</span><span class="p">()</span>
    <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>这就是 kube-proxy 的入口函数，实际上即起一个 proxy server daemon</p>
<p>可以看到通过 <code>informerFactory </code>新建了2个 config 对象(serviceConfig, endpointsConfig), 这个 <code>informerFactory</code> 是什么呢？</p>
<p>k8s 里所有资源都存在 etcd 中提供 api 通过 apiserver 的接口访问，其中有个核心的公共组件即 <code>informer</code> 是对 apiserver 资源访问的一层包装，其中包括 api 访问, localcache 等&hellip;</p>
<p>所以这里的两个 config 对象即用来获取 etcd 中 service 和 endpoints 的信息，他们都调用了 <code>RegisterEventHandler</code> 注册了一个回调函数，这个函数用来监听变更并发送变更信号。</p>
<p>最后用 goroutine 跑起来。</p>
<p>之后的 <code>informerFactory.Start()</code> 则用来初始化 informer 对象注册的回调函数。</p>
<p>最后把 proxy server loop 跑起来 <code>Proxier.SyncLoop()</code> 等待信号。</p>
<p>接着我们先看下 service 的  <code>NewServiceConfig</code> 这个函数，因为 endpoint 估计也是类似的。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// NewServiceConfig creates a new ServiceConfig.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">NewServiceConfig</span><span class="p">(</span><span class="nx">serviceInformer</span> <span class="nx">coreinformers</span><span class="p">.</span><span class="nx">ServiceInformer</span><span class="p">,</span> <span class="nx">resyncPeriod</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">)</span> <span class="o">*</span><span class="nx">ServiceConfig</span> <span class="p">{</span>
	<span class="nx">result</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">ServiceConfig</span><span class="p">{</span>
		<span class="nx">lister</span><span class="p">:</span>       <span class="nx">serviceInformer</span><span class="p">.</span><span class="nf">Lister</span><span class="p">(),</span>
		<span class="nx">listerSynced</span><span class="p">:</span> <span class="nx">serviceInformer</span><span class="p">.</span><span class="nf">Informer</span><span class="p">().</span><span class="nx">HasSynced</span><span class="p">,</span>
	<span class="p">}</span>

	<span class="nx">serviceInformer</span><span class="p">.</span><span class="nf">Informer</span><span class="p">().</span><span class="nf">AddEventHandlerWithResyncPeriod</span><span class="p">(</span>
		<span class="nx">cache</span><span class="p">.</span><span class="nx">ResourceEventHandlerFuncs</span><span class="p">{</span>
			<span class="nx">AddFunc</span><span class="p">:</span>    <span class="nx">result</span><span class="p">.</span><span class="nx">handleAddService</span><span class="p">,</span>
			<span class="nx">UpdateFunc</span><span class="p">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">handleUpdateService</span><span class="p">,</span>
			<span class="nx">DeleteFunc</span><span class="p">:</span> <span class="nx">result</span><span class="p">.</span><span class="nx">handleDeleteService</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="nx">resyncPeriod</span><span class="p">,</span>
	<span class="p">)</span>

	<span class="k">return</span> <span class="nx">result</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>看到它结构体里就两个对象 <code>lister</code> 和 <code>listerSynced</code>，所以我们接着看下 <code>serviceInformer</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">ServiceInformer</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nf">Informer</span><span class="p">()</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">SharedIndexInformer</span>
	<span class="nf">Lister</span><span class="p">()</span> <span class="nx">v1</span><span class="p">.</span><span class="nx">ServiceLister</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>看到是个通用对象 <code>SharedIndexInformer</code> 即上述提及的公共组件，故不往里深究。</p>
<p>接着回来看注册进去的回调函数，举个栗子，这儿的 <code>UpdateFunc: result.handleUpdateService</code> 最终会调到 <code>iptables.go</code> 里的 <code>OnServiceUpdate</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">ServiceConfig</span><span class="p">)</span> <span class="nf">handleUpdateService</span><span class="p">(</span><span class="nx">oldObj</span><span class="p">,</span> <span class="nx">newObj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
	<span class="nx">oldService</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">oldObj</span><span class="p">.(</span><span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Service</span><span class="p">)</span>
	<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
		<span class="nx">utilruntime</span><span class="p">.</span><span class="nf">HandleError</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;unexpected object type: %v&#34;</span><span class="p">,</span> <span class="nx">oldObj</span><span class="p">))</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="nx">service</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">newObj</span><span class="p">.(</span><span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Service</span><span class="p">)</span>
	<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
		<span class="nx">utilruntime</span><span class="p">.</span><span class="nf">HandleError</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;unexpected object type: %v&#34;</span><span class="p">,</span> <span class="nx">newObj</span><span class="p">))</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">c</span><span class="p">.</span><span class="nx">eventHandlers</span> <span class="p">{</span>
		<span class="nx">glog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Calling handler.OnServiceUpdate&#34;</span><span class="p">)</span>
		<span class="nx">c</span><span class="p">.</span><span class="nx">eventHandlers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nf">OnServiceUpdate</span><span class="p">(</span><span class="nx">oldService</span><span class="p">,</span> <span class="nx">service</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="kd">func</span> <span class="p">(</span><span class="nx">proxier</span> <span class="o">*</span><span class="nx">Proxier</span><span class="p">)</span> <span class="nf">OnServiceUpdate</span><span class="p">(</span><span class="nx">oldService</span><span class="p">,</span> <span class="nx">service</span> <span class="o">*</span><span class="nx">v1</span><span class="p">.</span><span class="nx">Service</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">proxier</span><span class="p">.</span><span class="nx">serviceChanges</span><span class="p">.</span><span class="nf">Update</span><span class="p">(</span><span class="nx">oldService</span><span class="p">,</span> <span class="nx">service</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">proxier</span><span class="p">.</span><span class="nf">isInitialized</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">proxier</span><span class="p">.</span><span class="nx">syncRunner</span><span class="p">.</span><span class="nf">Run</span><span class="p">()</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>所以监听到变更之后调用的这个 <code>proxier.syncRunner.Run()</code> 是什么呢，得看下这个 <code>syncRunner</code> 在做什么</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">proxier</span><span class="p">.</span><span class="nx">syncRunner</span> <span class="p">=</span> <span class="nx">async</span><span class="p">.</span><span class="nf">NewBoundedFrequencyRunner</span><span class="p">(</span><span class="s">&#34;sync-runner&#34;</span><span class="p">,</span> <span class="nx">proxier</span><span class="p">.</span><span class="nx">syncProxyRules</span><span class="p">,</span> <span class="nx">minSyncPeriod</span><span class="p">,</span> <span class="nx">syncPeriod</span><span class="p">,</span> <span class="nx">burstSyncs</span><span class="p">)</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">bfr</span> <span class="o">*</span><span class="nx">BoundedFrequencyRunner</span><span class="p">)</span> <span class="nf">Run</span><span class="p">()</span> <span class="p">{</span>
	<span class="c1">// If it takes a lot of time to run the underlying function, noone is really
</span><span class="c1"></span>	<span class="c1">// processing elements from &lt;run&gt; channel. So to avoid blocking here on the
</span><span class="c1"></span>	<span class="c1">// putting element to it, we simply skip it if there is already an element
</span><span class="c1"></span>	<span class="c1">// in it.
</span><span class="c1"></span>	<span class="k">select</span> <span class="p">{</span>
	<span class="k">case</span> <span class="nx">bfr</span><span class="p">.</span><span class="nx">run</span> <span class="o">&lt;-</span> <span class="kd">struct</span><span class="p">{}{}:</span>
	<span class="k">default</span><span class="p">:</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">bfr</span> <span class="o">*</span><span class="nx">BoundedFrequencyRunner</span><span class="p">)</span> <span class="nf">Loop</span><span class="p">(</span><span class="nx">stop</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span> <span class="p">{</span>
	<span class="nx">glog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;%s Loop running&#34;</span><span class="p">,</span> <span class="nx">bfr</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>
	<span class="nx">bfr</span><span class="p">.</span><span class="nx">timer</span><span class="p">.</span><span class="nf">Reset</span><span class="p">(</span><span class="nx">bfr</span><span class="p">.</span><span class="nx">maxInterval</span><span class="p">)</span>
	<span class="k">for</span> <span class="p">{</span>
		<span class="k">select</span> <span class="p">{</span>
		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">stop</span><span class="p">:</span>
			<span class="nx">bfr</span><span class="p">.</span><span class="nf">stop</span><span class="p">()</span>
			<span class="nx">glog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;%s Loop stopping&#34;</span><span class="p">,</span> <span class="nx">bfr</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>
			<span class="k">return</span>
		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">bfr</span><span class="p">.</span><span class="nx">timer</span><span class="p">.</span><span class="nf">C</span><span class="p">():</span>
			<span class="nx">bfr</span><span class="p">.</span><span class="nf">tryRun</span><span class="p">()</span>
		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">bfr</span><span class="p">.</span><span class="nx">run</span><span class="p">:</span>
			<span class="nx">bfr</span><span class="p">.</span><span class="nf">tryRun</span><span class="p">()</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>syncRunner</code> 里注册了个 <code>syncProxyRules</code> 的回调函数，而刚刚 updateSync 中触发的 run 函数则用 select 发送了一个 <code>bfr.run</code> 信号，之前所提及的 proxy server 一旦收到信号就会跑一次 <code>tryRun()</code>调用到这个 <code>syncProxyRules</code> 的回调函数。</p>
<p>于是我们走到 <code>syncProxyRules</code>, 这个函数特别长，但简而言之就是做一些 iptables 的 ensure 和 update 操作。</p>
<p>这样一来，整个流程就走通了。</p>
<p>靠北，开发 k8s 的 google 工程师真的很机车，代码真的有点绕哦！</p>
<h3 id="最后">最后</h3>
<p>最后我们来理一下 service &amp;&amp; endpoint &amp;&amp; kube-proxy 的关系。</p>
<p>service / endpoint 是pod对外暴露访问地址的封装，Kube-proxy 用来管理这些封装，做一些 ensure&amp;update 的操作</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="http://7xse6j.com1.z0.glb.clouddn.com/k8s_share.png"
        data-srcset="http://7xse6j.com1.z0.glb.clouddn.com/k8s_share.png, http://7xse6j.com1.z0.glb.clouddn.com/k8s_share.png 1.5x, http://7xse6j.com1.z0.glb.clouddn.com/k8s_share.png 2x"
        data-sizes="auto"
        alt="http://7xse6j.com1.z0.glb.clouddn.com/k8s_share.png"
        title="kube-proxy model" /></p></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2020-07-14&nbsp;<a class="git-hash" href="https://github.com/dillonzq/LoveIt/commit/0b8dc806dec6578f1ff9edd4106e8e937b3406a4" target="_blank" title="commit by Lexus Lee(lexuscyborg103@gmail.com) 0b8dc806dec6578f1ff9edd4106e8e937b3406a4: init hugo source codes">
                                    <i class="fas fa-hashtag fa-fw"></i>0b8dc80</a></span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/zh-cn/k8s-service-endpoints/index.md" target="_blank">阅读原始文档</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://example.com/zh-cn/k8s-service-endpoints/" data-title="浅谈 k8s service&amp;kube-proxy" data-via="lexuscyborg103" data-hashtags="Golang,Kubernetes,Linux"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Reddit" data-sharer="reddit" data-url="https://example.com/zh-cn/k8s-service-endpoints/"><i class="fab fa-reddit fa-fw"></i></a><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://example.com/zh-cn/k8s-service-endpoints/" data-title="浅谈 k8s service&amp;kube-proxy" data-ralateuid="thehackercat"><i class="fab fa-weibo fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Evernote" data-sharer="evernote" data-url="https://example.com/zh-cn/k8s-service-endpoints/" data-title="浅谈 k8s service&amp;kube-proxy"><i class="fab fa-evernote fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/zh-cn/tags/golang/">Golang</a>,&nbsp;<a href="/zh-cn/tags/kubernetes/">Kubernetes</a>,&nbsp;<a href="/zh-cn/tags/linux/">Linux</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/zh-cn/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/zh-cn/scarllet-sql-attack/" class="prev" rel="prev" title="记一次 postgresql 斯嘉丽约翰逊攻击的排查"><i class="fas fa-angle-left fa-fw"></i>记一次 postgresql 斯嘉丽约翰逊攻击的排查</a>
            <a href="/zh-cn/kubeproxy-ipvs-accident/" class="next" rel="next" title="记一次升级 kube-proxy ipvs 引发的线上故障">记一次升级 kube-proxy ipvs 引发的线上故障<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.73.0">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2019 - 2020</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">LexusLee</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/css/lightgallery.min.css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/algoliasearch@4.2.0/dist/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/js/lightgallery.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lg-zoom.js@1.2.0/dist/lg-zoom.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"search":{"algoliaAppID":"PASDMWALPK","algoliaIndex":"index.zh-cn","algoliaSearchKey":"b42948e51daaa93df92381c8e2ac0f93","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
